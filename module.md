C程序的模块化

/*待整理*/

在C语言的应用领域，如通讯领域和嵌入式系统领域，一个的软件项目通常包含很多复杂的
功能，实现这个项目不是一个程序员单枪匹马可以胜任的，往往需要一个团队的有效合作
，另外，在一个以C代码为主的完整的项目中，经常也需要加入一些其他语言的代码，例如
，C代码和汇编代码的混合使用，C和C++的同时使用。这些都增加了一个软件项目的复杂程
度，为了提高软件质量，合理组织的各种代码和文件是非常重要的。

组织代码和文件的目的是为了使团队合作更加有效，使软件项目有良好的可扩展性、可维
护性、可移植性、可裁减、可测试性，防止错误发生，提高软件的稳定性。

通常情况下,软件项目采用层次化结构和模块化开发的方法,例如,一个嵌入式软件项目可能
有驱动层,操作系统层,功能层,应用程序层,/*每一个层使用它的下层提供的接口,并为它的
上层提供调用接口*/,模块则是每一个层中完成一个功能的单元,例如驱动层的每一个设备
的驱动就是一个模块,应用层的每个应用程序就是一个模块,/*模块使用下层提供的接口和
同层其他模块提供的接口,完成特定功能,为上层和同层的其他模块提供调用接口*/。       
       
这里的接口是指一个功能模块暴露出来的，提供给其他模块的访问具体功能的方法。根据C
语言的特点，使用*.c文件实现模块的功能，/*使用*.h文件暴露单元的接口,在*.h文件里
声明外部其他模块可能是用的函数,数据类型,全局变量,类型定义,宏定义和常量定义.外部
模块只需包含*.h文件就可以使用相应的功能*/.当然,模块可以再细化为子模块.虽然我们
这里说的接口和COM(通用组件模型)里定义的接口不同,但是,根据COM里对接口的讨论,为了
使软件在修改时,一个模块的修改不会影响到其他模块的一个模块的修改不会导致其他模块
也需要修改,所以,接口第一次发布后,修改*.h文件不能导致使用这个接口的其他模块需要
重新编写，因此最初定义模块接口的时候必须充分考虑需求以及以后的可扩展性.      
       
根据C语言的特点,并借鉴一些成熟软件项目代码,总结C项目中代码文件组织的基本建议:      

1. 使用层次化和模块化的软件开发模型.每一个模块只能使用所在层和下一层模块提供的
   接口.      
2. 每个模块的文件包存在独立的一个文件夹中.通常情况下,实现一个模块的文件不止一个
   ,这些相关的文件应该保存在一个文件夹中.      
3. 用于模块裁减的条件编译宏保存在一个独立的文件里,便于软件裁减.      
4. 硬件相关代码和操作系统相关代码与纯C代码相对独立保存,以便于软件移植.      
5. 声明和定义分开,使用*.h文件暴露模块需要提供给外部的函数,宏,类型,常量,全局变量
   ,尽量做到模块对外部透明,用户在使用模块功能时不需要了解具体的实现,文件一旦发
   布,要修改一定要很慎重,      
6. 文件夹和文件命名要能够反映出模块的功能.      
7. 正式版本和测试版本使用统一文件，使用宏控制是否产生测试输出。      
8. 必要的注释不可缺少。      

1. 头文件中不能有可执行代码，也不能有数据的定义，只能有宏、类型
   (typedef,struct,union,enum)，数据和函数的声明。
        例如以下的代码可以包含在头文件里

```c
#define NAMESTRING "name"      
typedef unsigned long word;      
typedef struct{      
        int x;      
        int y;      
} Piont;      
extern Fun(void);      
extern int a;      
```
全局变量和函数的定义不能出现在*.h文件里。例如下面的代码不能包含在头文件：      

```c
int a;      
void Fun1(void)      
{      
        a++;      
}
```

2，头文件中不能包本地数据（模块自己使用的数据或函数，不被其他模块使用）。这一点
相当于面向对象程序设计里的私有成员，即只有模块自己使用的函数，数据，不要用
extent在头文件里声明，只有模块自己使用的宏，常量，类型也不要在头文件里声明，应
该在自己的*.c文件里声明。

3,含一些需要使用的声明。在头文件里声明外部需要使用的数据，函数，宏，类型。

4,防止被重复包含。使用下面的宏防止一个头文件被重复包含。      
    #ifndef MY_INCLUDE_H      
    #define MY_INCLUDE_H      
    <头文件内容 >      
    #endif

5，保证在使用这个头文件时，用户不用再包含使用此头文件的其他前提头文件，即要使用
的头文件已经包含在此头文件里。例如：area.h头文件包含了面积相关的操作，要使用这
个头文件不需同时包含了关于点操作的头文件piont.h。用户在使用area.h时不需要手动包
含piont.h,因为我们已经在 area.h中用 #include "point.h"包含了这个头文件。

关于头文件的分类以及使用说明.

1. 有一些头文件是为用户提供调用接口，这种头文件中声明了模块中需要给其他模块使用的
函数和数据：      
  1. 一个模块一个接口，不能几个模块用一个接口。      
  2. 文件名为和实现模块的c文件相同。abc.c--abc.h      
  3. 提供给其他模块的数据和函数即为全局变脸以及全局函数；
  3. 尽量不要使用extern来声明一些共享的数据。因为这种做法是不安全的，最好提供函数
     访问这些变量。
  4. 在作为接口的头文件中，尽量不要包含其他模块的那些暴露*.C文件中内容的头文件，
     但是可以包好一些不是用来暴露接口的头文件。      
  5. 为了提高接口的独立性和透明度,不要包含那些只有在可执行文件中才使用的头文件，
     这些头文件应该在*.c文件中包含。      
  6. 接口文件要有面向用户的充足的注释。从应用角度描述个暴露的内容。      
  7. 接口文件在发布后尽量避免修改，即使修改也要保证不影响用户程序。      

2. 多个代码文件使用一个接口文件：这种头文件用于那些认为一个模块使用一个文件太大
   的情况:
   1. 多个代码文件组成的一个模块只有一个接口文件。因为这些文件完成的是一个模块。      
   2. 使用模块下文件命名 <系统名 > <模块名命名 >      
   3. 不要滥用这种文件。      
   4. 有时候也会出现几个*.c文件用于共向数据的*.h文件，这种文件的特点是在一个*.c
	  文件里定义全局变量，而在其他*.c文件里使用，要将这种文件和用于暴露模块接口
	  的文件区别。(模块内部几个文件的全局变量交流，不用在给其他模块的接口头文件
	  中出现).
   5. 一个模块如果有几个子模块，可以用一个*.h文件暴露接口，在这个文件里用
	  #include包含每个子模块的接口文件。

3. 还有一种头文件，说明性头文件，这种头文件不需要有一个对应的代码文件，在这种文
   件里大多包含了大量的宏定义，没有暴露的数据变量和函数。
   1. 包含一些需要的概念性的东西.
   2. 命名方式,定义的功能.h 
   3. 不包含任何其他的头文件.
   4. 不定义任何类型.
   5. 不包含任何数据和函数声明.

4. 上面介绍了C头文件的一些建议，下面介绍C代码文件*.c文件的一些建议,*.c文件是C语
   言中生成汇编代码和机器码的内容，要注意以下建议：      
   1. 命名方式 模块名.c
   2. 用static修饰本地的数据和函数。      
   3. 不要使用extern。这是在*.h中使用的，可以被包含进来。      
   4. 无论什么时候定义内部的对象,确保独立与其他执行文件。      
   5. 这个文件里必须包含相应功能函数。


1,模块间的数据接口（也就是函数）应该事先较充分考虑，需要哪些接口，通过接口需要
操作哪些数据，尽量作到接口的不变性。

2,模块间地数据交换尽量通过接口完成(zhs:而不是通过全局变量extern来传递的)，方法
是通过函数传参数，为了保证程序高效和减少堆栈空间，传大量参数（如结构）应采用传
址的方式，通过指针作为函数参数或函数返回指针，尽量杜绝extern形式的全局变量，请
注意是extern形式的全局变量，模块内部(一个模块也可以是有多个*.c文件的)的全局变量
是允许和必须的。

3,传指针参数增加的开销主要是作参数的指针和局部指针的数据空间（嵌入式系统（如C51
）往往由于堆栈空间有限，函数参数会放到外部RAM的堆栈中），增加的代码开销仅是函数
的调用，带来的是良好的模块化结构，而且使用接口函数会比在代码中多处直接使用全局
变量大大节约代码空间。

4,需注意一点的事物总有他的两面性，水能载舟，也能覆舟。对于需要频繁访问的变量如
果仍采用接口传递，函数调用的开销是巨大的，这时应考虑仍采用extern全局变量。

为了使数据、方法能够封装在一起，提高代码的重用度，如对于一些与硬件相关的数据结
构，建议采用在数据结构中将访问该数据结构的函数定义为结构内部的函数指针。这样当
硬件变化，需要重写访问该硬件的函数，只要将重写的函数地址赋给该函数指针，高层代
码由于使用的是函数指针，所以完全不用动，实现代码重用。而且该函数指针可以通过传
参数或全局变量的方式传给高层代码，比较方便。例如：

```c
struct OneStruct
{
int m_imember；
int (*func)(int,int);
//……
}t2;
```
在ANSI C 语言中用什么来定义常量呢？答案是enum类型和#define宏，
这两个都可以用来定义常量。

C中'a'这样的字符常量是int类型的，而不是char类型的，为四个byte

5，功能函数与外部交互时，尽量做到高内聚低耦合，内部不使用全局变量，一般在参数中
传值或者传指针如果需要修改全局变量的话;

7，用函数指针数组代替switch-case
8，switch-case中要将调用最频繁的一项放在最前面
9，注意函数的可重入性问题，函数内部尽量不要调用全局变量，而应该通过参数传递
